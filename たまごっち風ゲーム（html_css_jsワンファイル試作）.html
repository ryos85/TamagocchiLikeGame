<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãŸã¾ã”ã£ã¡é¢¨ã‚²ãƒ¼ãƒ ï¼ˆè©¦ä½œï¼‰</title>
  <style>
    :root {
      --bg: #0f1220;
      --panel: #161a2b;
      --panel-2: #1d2240;
      --text: #e7ebff;
      --muted: #95a1ff88;
      --accent: #7aa2ff;
      --good: #35c759;
      --warn: #ffb020;
      --bad:  #ff4d4d;
      --barbg:#283059;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background: radial-gradient(1200px 1200px at 10% 0%, #1a1f3c 0,#0e1120 45%, #0b0d18 100%);
      color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    }
    header{
      padding: 16px 20px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
    }
    header h1{ font-size: clamp(18px, 3vw, 24px); margin:0; letter-spacing:.3px }
    header .meta{opacity:.8; font-size:14px}

    .wrap{$1padding:12px;$2}
    @media (max-width: 900px){ .wrap{ grid-template-columns: 1fr; } }

    .card{ background:linear-gradient(180deg, var(--panel) 0, var(--panel-2) 100%); border:1px solid #2a3367; border-radius:var(--radius); box-shadow: var(--shadow); overflow:hidden }
    .card h2{ font-size:16px; letter-spacing:.2px; margin:0; padding:10px 12px; background: #1b2040; border-bottom:1px solid #2a3367; opacity:.95 }
    .card .inner{ padding:12px }

    /* Pet area */
    .petbox{ display:grid; grid-template-rows: minmax(180px, 28vh) auto; gap:12px }
    .stage{ font-size:14px; opacity:.85 }
    .sprite{
      background: radial-gradient(180px 160px at 50% 35%, #2a356e 0, #1a2047 60%, #121737 100%);
      border-radius: 20px; border: 1px solid #2a3367; display:flex; align-items:center; justify-content:center;
      text-align:center; position:relative; overflow:hidden
    }
    .sprite .emoji{ font-size: 88px;$1}
    .species{ font-size:18px; font-weight:700; margin-top:6px }

    /* Gauges */
    .gauges{ display:grid; gap:10px; grid-template-columns: repeat(2, 1fr) }
    @media (max-width: 520px){ .gauges{ grid-template-columns: 1fr } }
    .gauge{ background: var(--barbg); border-radius:12px; padding:10px; border:1px solid #36407a }
    .gauge .row{ display:flex; align-items:center; justify-content:space-between; font-size:14px; margin-bottom:8px }
    .bar{ height: 12px; width: 100%; background:#161b36; border-radius: 10px; border:1px solid #2c356e; overflow:hidden }
    .bar > i{ display:block; height:100%; width:0%; background: linear-gradient(90deg, #6ea8ff, #8bc3ff); transition: width .4s ease }
    .bar.bad > i{ background: linear-gradient(90deg, #ff6666, #ff9b73) }
    .bar.warn > i{ background: linear-gradient(90deg, #ffb020, #ffd36d) }
    .num{ font-variant-numeric: tabular-nums; font-size:13px; opacity:.8 }

    /* Controls */
    .controls{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px }
    @media (max-width: 520px){ .controls{ grid-template-columns: repeat(2, 1fr); } }
    button{
      cursor:pointer; border:none; outline:none; padding:10px 8px; border-radius:12px; background:#24305f; color:var(--text);
      border:1px solid #32407a; font-size:13px; transition: transform .05s ease, background .2s ease, border .2s ease; font-weight:600
    }
    button:hover{ background:#2a3a77 }
    button:active{ transform: translateY(1px) }
    .danger{ background:#3a2440; border-color:#6b2a5b }

    .log{ max-height: 180px; overflow:auto; font-size:13px; line-height:1.5 }
    .log p{ margin:0; padding:8px 0; border-bottom:1px dashed #2a3367; opacity:.92 }

    .hint{ font-size:12px; opacity:.7; margin-top:8px }

    .flex{ display:flex; gap:10px; align-items:center; justify-content:space-between }
    .two-col{ display:grid; gap:12px; grid-template-columns: 1fr 1fr }

    .tag{ display:inline-block; padding:4px 8px; border:1px solid #2c356e; background:#1b2040; border-radius:999px; font-size:12px; opacity:.9 }
  </style>
</head>
<body>
  <header>
    <h1>ãŸã¾ã”ã£ã¡é¢¨ã‚²ãƒ¼ãƒ ï¼ˆè©¦ä½œï¼‰</h1>
    <div class="meta">
      <span id="metaDay">Day 0</span> Â· <span id="metaStage">ãŸã¾ã”</span>
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <h2>ãƒšãƒƒãƒˆ</h2>
      <div class="inner petbox">
        <div class="sprite">
          <div class="emoji" id="emoji">ğŸ¥š</div>
        </div>
        <div>
          <div class="stage">ã‚¹ãƒ†ãƒ¼ã‚¸ï¼š<b id="stage">ãŸã¾ã”</b>ã€€<span class="tag" id="speciesTag">â€”</span></div>
          <div class="species" id="species">â€”</div>
          <div class="hint">åŸºæœ¬æ“ä½œï¼š<b>ã‚¨ã‚µ</b>ãƒ»<b>é‹å‹•</b>ãƒ»<b>æƒé™¤</b>ã€‚<br/>ã€Œ1æ—¥é€²ã‚ã‚‹ã€ã§æ—¥ã‚’é€ã‚‹ï¼ˆé€²åŒ–ã®åˆ¤å®šã¯ä¸»ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰</div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
      <div class="inner">
        <div class="gauges">
          <div class="gauge">
            <div class="row"><span>ãªã¤ãåº¦</span><span class="num" id="affNum">0</span></div>
            <div class="bar" id="affBar"><i></i></div>
          </div>
          <div class="gauge">
            <div class="row"><span>æº€è…¹åº¦</span><span class="num" id="fullNum">50</span></div>
            <div class="bar" id="fullBar"><i></i></div>
          </div>
          <div class="gauge">
            <div class="row"><span>æ¸…æ½”åº¦</span><span class="num" id="cleanNum">80</span></div>
            <div class="bar" id="cleanBar"><i></i></div>
          </div>
          <div class="gauge">
            <div class="row"><span>å¥åº·åº¦ï¼ˆè‡ªå‹•ï¼‰</span><span class="num" id="hpNum">100</span></div>
            <div class="bar" id="hpBar"><i></i></div>
          </div>
          <div class="gauge">
            <div class="row"><span>é‹å‹•é‡ï¼ˆç´¯ç©ï¼‰</span><span class="num" id="runNum">0</span></div>
            <div class="bar" id="runBar"><i></i></div>
          </div>
          <div class="gauge">
            <div class="row"><span>æ¬¡ã®é€²åŒ–ã¾ã§</span><span class="num" id="evoNum">0%</span></div>
            <div class="bar" id="evoBar"><i></i></div>
          </div>
        </div>

        <div class="hint">â€»å¥åº·åº¦ã¯ã€æº€è…¹åº¦ã‚„æ¸…æ½”åº¦ãŒä½ã„ã¨ä¸‹ãŒã‚Šã€è‰¯å¥½ãªã‚‰å°‘ã—å›å¾©ã—ã¾ã™ã€‚</div>
      </div>
    </section>

    <section class="card">
      <h2>æ“ä½œ</h2>
      <div class="inner">
        <div class="controls">
          <button id="btnFeed">ğŸ™ ã‚¨ã‚µã‚’ã‚ã’ã‚‹</button>
          <button id="btnRun">ğŸƒâ€â™€ï¸ é‹å‹•ã•ã›ã‚‹</button>
          <button id="btnClean">ğŸ§¹ ã‚±ãƒ¼ã‚¸ã‚’æƒé™¤</button>
          <button id="btnNext">ğŸ—“ï¸ 1æ—¥é€²ã‚ã‚‹</button>
        </div>
        <div class="flex" style="margin-top:10px">
          <button class="danger" id="btnReset">ğŸ” ãƒªã‚»ãƒƒãƒˆ</button>
          <small class="hint">ä¿å­˜ã¯è‡ªå‹•ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰ã€‚</small>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°</h2>
      <div class="inner log" id="log"></div>
    </section>
  </div>

  <script>
  const MAX = 100;
  const clamp = (n, min=0, max=MAX)=> Math.max(min, Math.min(max, n));

  const STAGES = ["ãŸã¾ã”","å¹¼å¹´æœŸ","æˆé•·æœŸ","æˆç†ŸæœŸ","å®Œå…¨ä½“"];
  const EMOJI  = ["ğŸ¥š","ğŸ£","ğŸ¥","ğŸ¤","ğŸ•Šï¸"];

  const SPECIES = {
    baby: "ãƒ™ãƒ“ãƒ³",
    grow: { friendly: "ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚ª", athlete: "ãƒã‚·ãƒ«ãƒ", tidy: "ãƒ”ã‚«ãƒªãƒ³", foodie: "ãƒ ã‚¯ãƒ ã‚¯" },
    adult: { friendly: "ã‚¢ãƒŸãƒ†ã‚£ã‚¢", athlete: "ãƒ€ãƒƒã‚·ãƒ¥ã‚ªã‚¦", tidy: "ã‚¯ãƒªãƒ³ãƒ™ãƒ«", foodie: "ã‚°ãƒ«ãƒŸã‚¢" },
    perfect: { friendly: "ã‚½ã‚¦ãƒ«ãƒªãƒ³ã‚¯", athlete: "ã‚¹ãƒˆãƒ©ã‚¤ã‚¶ãƒ¼", tidy: "ãƒ—ãƒªã‚ºãƒ ã‚¯ãƒªãƒ¼ãƒ³", foodie: "ãƒãƒ³ã‚±ãƒƒãƒˆã‚¥ã‚¹" }
  };

  const el = id => document.getElementById(id);

  let state = {
    version: 1,
    day: 0,
    stageIdx: 0, // 0..4
    speciesKey: null, // friendly | athlete | tidy | foodie
    speciesName: "â€”",
    affection: 0,      // ãªã¤ãåº¦ 0..100
    fullness: 50,      // æº€è…¹åº¦ 0..100
    cleanliness: 80,   // æ¸…æ½”åº¦ 0..100
    health: 100,       // å¥åº·åº¦ 0..100ï¼ˆè‡ªå‹•ï¼‰
    exerciseTotal: 0,  // é‹å‹•é‡ ç´¯ç©
    history: [],       // 1æ—¥ã”ã¨ã®å¹³å‡ãƒ­ã‚° {aff,full,clean,health,run}
    evoProgress: 0,    // æ¬¡ã®é€²åŒ–ã¾ã§ã®é€²æ—ï¼ˆ%ï¼‰
    log: []
  };

  function save(){
    try{ localStorage.setItem('tamagotchi_like_save', JSON.stringify(state)); }catch(e){ console.warn(e); }
  }
  function load(){
    try{
      const s = JSON.parse(localStorage.getItem('tamagotchi_like_save'));
      if(s && s.version===1){ state = s; }
    }catch(e){ console.warn(e); }
  }

  function pushLog(msg){
    state.log.unshift(`[Day ${state.day}] ${msg}`);
    state.log = state.log.slice(0, 60);
  }

  function avg(arr, key){ if(arr.length===0) return 0; return arr.reduce((a,b)=>a+(b[key]||0),0)/arr.length; }

  function computeTraitScores(){
    const recent = state.history.slice(-5);
    const affA = (avg(recent, 'aff') + state.affection)/2; // æœ€è¿‘å¹³å‡ã¨ç¾åœ¨ã®å¹³å‡
    const fullA = (avg(recent, 'full') + state.fullness)/2;
    const cleanA= (avg(recent, 'clean') + state.cleanliness)/2;
    const runN = Math.min(state.exerciseTotal, 200) / 200 * 100; // ä¸Šé™200ã§æ­£è¦åŒ–
    return {
      friendly: affA,           // é«˜ã„ã»ã©å‹å¥½çš„
      athlete: runN,            // é«˜ã„ã»ã©é‹å‹•ç‰¹åŒ–
      tidy: cleanA,             // é«˜ã„ã»ã©æ¸…æ½”
      foodie: fullA             // é«˜ã„ã»ã©é£Ÿã„ã—ã‚“åŠ
    };
  }

  function computeEvoProgress(){
    const traits = computeTraitScores();
    let progress = 0;
    if(state.stageIdx===0){
      // ãŸã¾ã”â†’å¹¼å¹´æœŸï¼šä½•ã‹ã—ã‚‰ä¸–è©±ã‚’ã—ãŸã‚‰/æ—¥ãŒé€²ã‚“ã ã‚‰å­µåŒ–
      progress = (state.day>0 || state.fullness>50 || state.affection>0 || state.cleanliness<80) ? 100 : 0;
    } else if(state.stageIdx===1){
      // å¹¼å¹´æœŸâ†’æˆé•·æœŸï¼š4è¦ç´ ã‚’å‡ç­‰è©•ä¾¡
      const aff = state.affection; const full = state.fullness; const clean = state.cleanliness;
      const run = Math.min(state.exerciseTotal, 40)/40*100;
      progress = (aff + full + clean + run) / 4;
    } else if(state.stageIdx===2){
      // æˆé•·æœŸâ†’æˆç†ŸæœŸï¼šå¹³å‡é‡è¦– + é‹å‹•
      const recent = state.history.slice(-5);
      const aff = (avg(recent,'aff') + state.affection)/2;
      const full= (avg(recent,'full') + state.fullness)/2;
      const clean=(avg(recent,'clean') + state.cleanliness)/2;
      const run = Math.min(state.exerciseTotal, 120)/120*100;
      progress = aff*0.35 + run*0.35 + clean*0.2 + full*0.1;
    } else if(state.stageIdx===3){
      // æˆç†ŸæœŸâ†’å®Œå…¨ä½“ï¼šãƒˆãƒƒãƒ—ç‰¹æ€§ + å¥åº·
      const t = computeTraitScores();
      const top = Math.max(t.friendly, t.athlete, t.tidy, t.foodie);
      progress = top*0.8 + state.health*0.2;
    } else {
      progress = 100;
    }
    state.evoProgress = clamp(progress, 0, 100);
  }

  function tryEvolve(){
    computeEvoProgress();
    if(state.evoProgress < 100 || state.stageIdx>=4) return;

    if(state.stageIdx===0){
      state.stageIdx=1; state.speciesName = SPECIES.baby; state.speciesKey=null;
      pushLog('ãŸã¾ã”ãŒå­µåŒ–ï¼å¹¼å¹´æœŸã€Œ'+state.speciesName+'ã€ã«ãªã£ãŸã€‚');
    } else if(state.stageIdx===1){
      const t = computeTraitScores();
      const key = Object.entries(t).sort((a,b)=>b[1]-a[1])[0][0];
      state.stageIdx=2; state.speciesKey = key; state.speciesName = SPECIES.grow[key];
      pushLog(`æˆé•·æœŸã«é€²åŒ–ï¼ã‚¿ã‚¤ãƒ—ã¯ã€Œ${key}ã€ â†’ ${state.speciesName}`);
    } else if(state.stageIdx===2){
      const key = state.speciesKey || 'friendly';
      state.stageIdx=3; state.speciesName = SPECIES.adult[key];
      pushLog(`æˆç†ŸæœŸã«é€²åŒ–ï¼${state.speciesName}`);
    } else if(state.stageIdx===3){
      const key = state.speciesKey || 'friendly';
      if(state.health < 60){
        pushLog('å¥åº·åº¦ãŒä½ãã¦å®Œå…¨ä½“ã«ãªã‚Œãªã‹ã£ãŸâ€¦ï¼ˆå¥åº·åº¦60ä»¥ä¸ŠãŒç›®å®‰ï¼‰');
        state.evoProgress = 99; // ã‚‚ã†å°‘ã—
      } else {
        state.stageIdx=4; state.speciesName = SPECIES.perfect[key];
        pushLog(`å®Œå…¨ä½“ã«åˆ°é”ï¼${state.speciesName}`);
      }
    }

    updateUI(); save();
  }

  function hatchIfNeeded(){
    if(state.stageIdx===0){
      computeEvoProgress();
      if(state.evoProgress>=100){ tryEvolve(); }
    }
  }

  // --- Actions ---
  function feed(){
    const before = state.fullness;
    state.fullness = clamp(state.fullness + 25);
    if(before>90){ state.health = clamp(state.health - 5); pushLog('é£Ÿã¹éãã§å°‘ã—è‹¦ã—ãã†â€¦å¥åº·åº¦ -5'); }
    else { state.affection = clamp(state.affection + 2); }
    state.cleanliness = clamp(state.cleanliness - 5);
    pushLog('ã‚¨ã‚µã‚’ã‚ã’ãŸï¼ˆæº€è…¹åº¦ +25 / æ¸…æ½”åº¦ -5 / ãªã¤ã +2ï¼‰');
    hatchIfNeeded();
    afterAction();
  }
  function run(){
    state.exerciseTotal += 10;
    state.fullness = clamp(state.fullness - 10);
    state.cleanliness = clamp(state.cleanliness - 3);
    if(state.fullness < 15){ state.health = clamp(state.health - 6); state.affection = clamp(state.affection - 2); pushLog('ãŠè…¹ãŒã™ãã™ãã¦ã¤ã‚‰ãã†â€¦å¥åº·åº¦ -6 / ãªã¤ã -2'); }
    else { state.affection = clamp(state.affection + 1); }
    pushLog('é‹å‹•ã—ãŸï¼ˆé‹å‹•é‡ +10 / æº€è…¹åº¦ -10 / æ¸…æ½”åº¦ -3 / ãªã¤ã +1ï¼‰');
    hatchIfNeeded();
    afterAction();
  }
  function clean(){
    const delta = (state.cleanliness<50)? 40: 25;
    state.cleanliness = clamp(state.cleanliness + delta);
    state.affection = clamp(state.affection + 1);
    pushLog(`ã‚±ãƒ¼ã‚¸ã‚’æƒé™¤ï¼ˆæ¸…æ½”åº¦ +${delta} / ãªã¤ã +1ï¼‰`);
    hatchIfNeeded();
    afterAction();
  }

  function nextDay(){
    state.day += 1;
    state.fullness = clamp(state.fullness - 20);
    state.cleanliness = clamp(state.cleanliness - 15);

    // health auto change
    let hDelta = 0;
    if(state.fullness < 30) hDelta -= 10;
    if(state.cleanliness < 30) hDelta -= 10;
    if(state.fullness >= 60 && state.cleanliness >= 60) hDelta += 6;
    state.health = clamp(state.health + hDelta);

    // affection reacts to neglect
    if(state.fullness < 25 || state.cleanliness < 25){ state.affection = clamp(state.affection - 6); }

    // log day summary into history
    state.history.push({ aff: state.affection, full: state.fullness, clean: state.cleanliness, health: state.health, run: state.exerciseTotal });
    if(state.history.length>60) state.history.shift();

    pushLog(`1æ—¥çµŒéï¼ˆæº€è…¹ -20 / æ¸…æ½” -15 / å¥åº· ${hDelta>=0?'+':''}${hDelta}ï¼‰`);
    hatchIfNeeded();
    afterAction();
  }

  function resetAll(){
    state = { version:1, day:0, stageIdx:0, speciesKey:null, speciesName:'â€”', affection:0, fullness:50, cleanliness:80, health:100, exerciseTotal:0, history:[], evoProgress:0, log:[] };
    pushLog('ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    updateUI(); save();
  }

  // --- UI ---
  function setBar(id, val){
    const bar = el(id).querySelector('i');
    bar.style.width = `${clamp(val)}%`;
    const shell = el(id);
    shell.classList.remove('bad','warn');
    if(val<30) shell.classList.add('bad'); else if(val<60) shell.classList.add('warn');
  }

  function updateUI(){
    computeEvoProgress();

    el('metaDay').textContent = `Day ${state.day}`;
    el('metaStage').textContent = STAGES[state.stageIdx];
    el('stage').textContent = STAGES[state.stageIdx];
    el('species').textContent = state.speciesName || 'â€”';
    el('speciesTag').textContent = state.speciesKey? `ã‚¿ã‚¤ãƒ—ï¼š${state.speciesKey}`: 'â€”';

    el('emoji').textContent = EMOJI[state.stageIdx];

    el('affNum').textContent  = state.affection;
    el('fullNum').textContent = state.fullness;
    el('cleanNum').textContent= state.cleanliness;
    el('hpNum').textContent   = state.health;
    el('runNum').textContent  = state.exerciseTotal;

    setBar('affBar', state.affection);
    setBar('fullBar', state.fullness);
    setBar('cleanBar', state.cleanliness);
    setBar('hpBar', state.health);
    setBar('runBar', Math.min(state.exerciseTotal, 100));

    el('evoNum').textContent = `${Math.round(state.evoProgress)}%`;
    setBar('evoBar', state.evoProgress);

    // log render
    const logHtml = state.log.map(l=>`<p>${l.replace(/[&<>]/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[s]))}</p>`).join('');
    el('log').innerHTML = logHtml || '<p>ã“ã“ã«å‡ºæ¥äº‹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>';

    // Save after UI update
    save();

    // Try to evolve when bar hits 100
    if(state.evoProgress>=100){
      tryEvolve(); // updates again inside
    }
  }

  function afterAction(){
    updateUI();
  }

  // --- Bind ---
  el('btnFeed').addEventListener('click', feed);
  el('btnRun').addEventListener('click', run);
  el('btnClean').addEventListener('click', clean);
  el('btnNext').addEventListener('click', nextDay);
  el('btnReset').addEventListener('click', ()=>{ if(confirm('æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) resetAll(); });

  // init
  load();
  updateUI();
  pushLog('ã‚ˆã†ã“ãï¼ãŠä¸–è©±ã‚’å§‹ã‚ã‚ˆã†ã€‚');
  updateUI();
  </script>
</body>
</html>
